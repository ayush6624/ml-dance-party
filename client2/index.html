<!DOCTYPE html>
<html>
  <head>
    <title>Dancing Party!!</title>

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="index.css" />
    <script src="https://kit.fontawesome.com/a1a8b812e3.js" crossorigin="anonymous"></script>
  </head>

  <body class="dark">
    <div id="canvas-container">
      <h1 id="count-down">Test</h1>
      <div class="buttons">
        <button id="record-button">Start Recording</button>
        <button id="camera-button">camera</button>
      </div>
    </div>

    <canvas id="output"></canvas>

    <aside class="sidebar">
      <video id="video" playsinline style="transform: scaleX(-1)"></video>
      <div class="songs">
        <h1 class="song-header">Songs</h1>
      </div>
      <div class="song-controls">
        <i class="fas fa-step-backward" onclick="player.nextTrack()"></i>
        <i class="fas fa-play" id="play"></i>
        <i class="fas fa-step-forward" onclick="player.previousTrack()"></i>
        <button id="authorize">Sign in</button>
      </div>
    </aside>

    <script src="https://cdn.socket.io/socket.io-3.0.1.min.js"></script>
    <script src="main.js"></script>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
      document.getElementById('play').addEventListener('click', toggle);
      document.getElementById('authorize').addEventListener('click', authorize);
      var player;
      var paused = true;
      var hash = window.location.hash.substr(1);
      var result = hash.split('&').reduce(function (res, item) {
        var parts = item.split('=');
        res[parts[0]] = parts[1];
        return res;
      }, {});
      const token = result['access_token'];

      window.onSpotifyWebPlaybackSDKReady = () => {
        console.log(token);
        player = new Spotify.Player({
          name: 'Web Playback SDK Quick Start Player',
          getOAuthToken: (cb) => {
            cb(token);
          },
        });

        player.on('player_state_changed', (state) => {
          console.log(state);
          // $('#current-track').attr('src', state.track_window.current_track.album.images[0].url);
          // $('#current-track-name').text(state.track_window.current_track.name);
        });

        // Error handling
        player.addListener('initialization_error', ({ message }) => {
          console.error(message);
        });
        player.addListener('authentication_error', ({ message }) => {
          console.error(message);
        });
        player.addListener('account_error', ({ message }) => {
          console.error(message);
        });
        player.addListener('playback_error', ({ message }) => {
          console.error(message);
        });

        // Playback status updates
        player.addListener('player_state_changed', (state) => {
          console.log(state);
        });

        // Ready
        player.addListener('ready', ({ device_id }) => {
          console.log('Ready with Device ID', device_id);
        });

        // Not Ready
        player.addListener('not_ready', ({ device_id }) => {
          console.log('Device ID has gone offline', device_id);
        });

        // Connect to the player!
        player.connect();
      };

      function toggle() {
        if (paused) {
          document.getElementById('play').classList.replace('fa-play', 'fa-pause');
          player.resume();
          paused = false;
        } else {
          document.getElementById('play').classList.replace('fa-pause', 'fa-play');
          player.pause();
          paused = true;
        }
      }

      function authorize() {
        const hash = window.location.hash
          .substring(1)
          .split('&')
          .reduce(function (initial, item) {
            if (item) {
              var parts = item.split('=');
              initial[parts[0]] = decodeURIComponent(parts[1]);
            }
            return initial;
          }, {});
        window.location.hash = '';

        // Set token
        let _token = hash.access_token;

        const authEndpoint = 'https://accounts.spotify.com/authorize';
        const clientId = '2ca11aea349e46dda03164bae582644e';
        const redirectUri = 'http://localhost:1234';
        const scopes = ['streaming', 'user-modify-playback-state'];
        if (!_token) {
          window.location = `${authEndpoint}?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scopes.join('%20')}&response_type=token&show_dialog=true`;
        }
      }
    </script>
  </body>
</html>
